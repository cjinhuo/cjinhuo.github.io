<section class='giscus mx-auto mt-10 w-full'>
  <div id='giscus-loading' class='text-skin-neutral-5 text-center py-4'>
    Loading comments...
  </div>
</section>

<script>
  const initGiscus = () => {
    const container = document.querySelector('.giscus')
    if (!container) {
      const oldScript = document.querySelector('script[src="https://giscus.app/client.js"]')
      if (oldScript) {
        oldScript.remove()
      }
      return
    }

    const loadGiscus = () => {
      const loadingEl = document.getElementById('giscus-loading')
      if (loadingEl) loadingEl.remove()

      const oldScript = document.querySelector('script[src="https://giscus.app/client.js"]')
      if (oldScript) {
        oldScript.remove()
      }

      const script = document.createElement('script')
      script.src = 'https://giscus.app/client.js'
      script.setAttribute('data-repo', 'cjinhuo/cjinhuo.github.io')
      script.setAttribute('data-repo-id', 'MDEwOlJlcG9zaXRvcnk2OTk2NDgwNw==')
      script.setAttribute('data-category', 'General')
      script.setAttribute('data-category-id', 'DIC_kwDOBCuUB84Cx9F9')
      script.setAttribute('data-mapping', 'title')
      script.setAttribute('data-strict', '0')
      script.setAttribute('data-reactions-enabled', '1')
      script.setAttribute('data-emit-metadata', '0')
      script.setAttribute('data-input-position', 'top')
      script.setAttribute('data-theme', 'preferred_color_scheme')
      script.setAttribute('data-lang', 'zh-CN')
      script.setAttribute('data-loading', 'lazy')
      script.crossOrigin = 'anonymous'
      script.async = true

      document.body.appendChild(script)
    }

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              loadGiscus()
              observer.disconnect()
            }
          })
        },
        { rootMargin: '200px' }
      )
      observer.observe(container)
    } else {
      loadGiscus()
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGiscus)
  } else {
    initGiscus()
  }

  document.addEventListener('astro:page-load', initGiscus)
  document.addEventListener('astro:after-swap', initGiscus)
</script>
